# NOTE: This does not use the il2cppassemblies stuff
name: Build, Release, and Version Check

permissions:
  contents: read

on:
  push:
    branches: [ "*" ]
    tags: [ "v*" ]
  pull_request:
    branches: [ "*" ]

jobs:
  check:
    runs-on: ubuntu-latest
    environment: check

    outputs:
      dllversion: ${{ steps.setversion.outputs.dllversion }}

    steps:
      - uses: actions/checkout@v6
        with:
          sparse-checkout: |
            manifest.json
            ${{ vars.CSPROJ_LOCATION }}
            ${{ vars.BUILDINFO_LOCATION }}
            CHANGELOG.md

      - name: Get version from manifest
        id: setversion
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $version = (Get-Content manifest.json | ConvertFrom-Json).version_number
          Write-Output "VERSIONNUM=$version" >> $env:GITHUB_ENV
          Write-Output "dllversion=$version" >> $env:GITHUB_OUTPUT
          Write-Host "DLLVERSION=$version"

      - name: Check .csproj
        shell: bash
        run: |
          version_number=$(awk -F'[<>]' '/<VersionPrefix>/ {print $3}' ${{ vars.CSPROJ_LOCATION }})
          if [ "$version_number" != "$VERSIONNUM" ]; then
            echo "Error: got version $version_number, expected $VERSIONNUM"
            exit 1
          fi

      - name: Check .cs
        shell: bash
        run: |
          version_number=$(awk -F'"' '/const string ModVersion/ {print $2; exit}' ${{ vars.BUILDINFO_LOCATION }})
          if [ "$version_number" != "$VERSIONNUM" ]; then
            echo "Error: got version $version_number, expected $VERSIONNUM"
            exit 1
          fi

      - name: Check changelog
        shell: bash
        run: |
          if [ "$(head -n 1 CHANGELOG.md)" != "# v$VERSIONNUM" ]; then
            echo "Error: first line of CHANGELOG.md is not '# v$VERSIONNUM'"
            exit 1
          fi

      - name: Check tag
        shell: bash
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          version_number="${GITHUB_REF#refs/tags/v}"
          if [ "$version_number" != "$VERSIONNUM" ]; then
            echo "Error: got version $version_number, expected $VERSIONNUM"
            exit 1
          fi

  build:
    needs: check
    runs-on: windows-latest
    environment: build

    env:
      LIBSDIRPATH: ${{ github.workspace }}\deps
      DLLVERSION: ${{ needs.check.outputs.dllversion }}
        
    steps:
      - uses: actions/checkout@v6

      - name: Get deps hash
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $dependencies = (Get-Content manifest.json | ConvertFrom-Json).dependencies -join "`n"
          $bytes = [System.Text.Encoding]::UTF8.GetBytes($dependencies)
          $memoryStream = [System.IO.MemoryStream]::new($bytes)
          $hash = Get-FileHash -InputStream $memoryStream -Algorithm SHA256
          $lowerhash = $hash.Hash.ToLower()
          Write-Output "DEPSHASH=$lowerhash" >> $env:GITHUB_ENV
          Write-Host "DEPSHASH=$lowerhash"
          Write-Host "Dependencies:`n$dependencies"

      - name: Restore Thunderstore deps cache
        if: ${{ env.DEPSHASH != '' }}
        id: cache-deps
        uses: actions/cache/restore@v5
        with:
          key: thunderstore-deps-${{ env.DEPSHASH }}
          path: ${{ env.LIBSDIRPATH }}

      - name: Download dependencies
        if: steps.cache-deps.outputs.cache-hit != 'true'
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $deps = (Get-Content manifest.json | ConvertFrom-Json).dependencies
          New-Item -ItemType Directory -Force -Path $env:LIBSDIRPATH | Out-Null
          foreach ($dep in $deps) {
            $parts = $dep -split '-'
            $user = $parts[0]; $pkg = $parts[1]; $ver = $parts[2]
            $url = "https://thunderstore.io/package/download/$user/$pkg/$ver"
            $out = Join-Path $env:LIBSDIRPATH "$($user)-$($pkg)-$($ver).zip"
            Write-Host "Fetching $url â†’ $out"
            Invoke-WebRequest -Uri $url -OutFile $out
          }

      - name: Unzip dependencies
        if: steps.cache-deps.outputs.cache-hit != 'true'
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $detectionPath = Join-Path $env:LIBSDIRPATH "*.zip"
          Get-ChildItem $detectionPath | ForEach-Object {
            $zip = $_.FullName
            Write-Host "Extracting $zip"
            Expand-Archive -Path $zip -DestinationPath $env:LIBSDIRPATH -Force
          }

      - name: Clean files in deps
        if: steps.cache-deps.outputs.cache-hit != 'true'
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $removedFiles = Get-ChildItem -Path $env:LIBSDIRPATH -File | Where-Object { $_.Name -ne "version.dll" }
          foreach ($file in $removedFiles) {
            Write-Host "Removing file: $($file.FullName)"
            Remove-Item -Path $file.FullName -Force
          }

      - name: Save Thunderstore deps cache
        if: ${{ env.DEPSHASH != '' && steps.cache-deps.outputs.cache-hit != 'true' }}
        uses: actions/cache/save@v5
        with:
          key: thunderstore-deps-${{ env.DEPSHASH }}
          path: ${{ env.LIBSDIRPATH }}

      - name: Setup .NET SDK 6.0
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: '6.0.x'
        
      # - name: Update & clean workloads (Only run if needed)
      #   continue-on-error: true
      #   run: |
      #     dotnet workload list
      #     dotnet workload update
      #     dotnet workload clean

      - name: Build
        run: dotnet build --configuration Release --no-self-contained -o "${{ vars.DLLNAME_NO_EXT }}\bin\Release" /p:LIBSDIRPATH=${{ env.LIBSDIRPATH }}
      
      - name: Test
        run: dotnet test --configuration Release --no-build --no-restore --verbosity normal /p:LIBSDIRPATH=${{ env.LIBSDIRPATH }}

      - name: Artifact setup
        if: ${{ env.DLLVERSION != '' }}
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $binPath = "${{ vars.DLLNAME_NO_EXT }}\bin\Release"
          New-Item -ItemType Directory -Force -Path $binPath\artifactsetup\Mods
          Move-Item -Path $binPath\${{ vars.DLLNAME_NO_EXT }}.dll -Destination $binPath\artifactsetup\Mods
          Copy-Item -Path CHANGELOG.md -Destination $binPath\artifactsetup
          Copy-Item -Path README.md -Destination $binPath\artifactsetup
          Copy-Item -Path icon.png -Destination $binPath\artifactsetup
          Copy-Item -Path LICENSE.txt -Destination $binPath\artifactsetup
          Copy-Item -Path manifest.json -Destination $binPath\artifactsetup
          Write-Output "BINPATH=$binPath" >> $env:GITHUB_ENV
          ls -R $binPath\artifactsetup

      - name: Upload build artifact
        if: ${{ env.DLLVERSION != '' }}
        uses: actions/upload-artifact@v6
        with:
         name: ninjaguardian-${{ vars.DLLNAME_NO_EXT }}-${{ env.DLLVERSION }}
         path: ${{ env.BINPATH }}\artifactsetup

  release:
    needs: [check, build]
    runs-on: ubuntu-latest
    environment: publish
    permissions:
      contents: write
    env:
      DLLVERSION: ${{ needs.check.outputs.dllversion }}
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - uses: actions/checkout@v6
        with:
          sparse-checkout: CHANGELOG.md

      - name: Download build artifact
        uses: actions/download-artifact@v7
        with:
          name: ninjaguardian-${{ vars.DLLNAME_NO_EXT }}-${{ env.DLLVERSION }}
          path: artifact-download

      - name: Zip artifact
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          Compress-Archive -Path artifact-download\* -DestinationPath ninjaguardian-${{ vars.DLLNAME_NO_EXT }}-${{ env.DLLVERSION }}.zip

      - name: Extract changelog for release
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $version = "v${{ env.DLLVERSION }}"
          $lines = Get-Content CHANGELOG.md

          $startIndex = -1
          for ($i = 0; $i -lt $lines.Length; $i++) {
            if ($lines[$i] -match "^# $version") {
              $startIndex = $i
              break
            }
          }

          if ($startIndex -eq -1) {
            Write-Error "Version $version not found in CHANGELOG.md"
            exit 1
          }

          $endIndex = -1
          for ($j = $startIndex + 1; $j -lt $lines.Length; $j++) {
            if ($lines[$j] -match "^# v") {
              $endIndex = $j
              break
            }
          }
          if ($endIndex -eq -1) {
            $endIndex = $lines.Length
          }

          $changelogLines = $lines[($startIndex+1)..($endIndex-1)] | Where-Object { $_ -ne "" }

          $body = $changelogLines -join "`n"

          Write-Output "body<<EOF" >> $env:GITHUB_ENV
          Write-Output $body >> $env:GITHUB_ENV
          Write-Output "EOF" >> $env:GITHUB_ENV
          Write-Host "$body"

      - name: Create GitHub Release and upload artifact
        uses: softprops/action-gh-release@v2
        with:
          files: ninjaguardian-${{ vars.DLLNAME_NO_EXT }}-${{ env.DLLVERSION }}.zip
          body: ${{ env.body }}
